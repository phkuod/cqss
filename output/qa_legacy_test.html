<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CQSS Project Gantt Chart</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f8f9fa;
            height: 100vh;
            overflow: hidden;
        }
        
        .container {
            width: 100%;
            height: calc(100vh - 40px);
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }
        
        .header {
            text-align: center;
            padding: 15px 20px;
            border-bottom: 2px solid #e9ecef;
            flex-shrink: 0;
            background: white;
            border-radius: 8px 8px 0 0;
        }
        
        .header h1 {
            color: #343a40;
            margin: 0;
            font-size: 2.2em;
        }
        
        .header p {
            color: #6c757d;
            margin: 8px 0 0 0;
            font-size: 1.0em;
        }
        
        .gantt-container {
            flex: 1;
            overflow: auto;
            border: none;
            position: relative;
        }
        
        .gantt-chart {
            width: 100%;
            height: 100%;
        }
        
        /* Enhanced scrollbar styling */
        .gantt-container {
            scrollbar-width: thin;
            scrollbar-color: #6c757d #f8f9fa;
        }
        
        .gantt-container::-webkit-scrollbar {
            width: 16px;
            height: 16px;
        }
        
        .gantt-container::-webkit-scrollbar-track {
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .gantt-container::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #6c757d 0%, #5a6268 100%);
            border-radius: 8px;
            border: 2px solid #f8f9fa;
            min-height: 20px;
        }
        
        .gantt-container::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #5a6268 0%, #495057 100%);
        }
        
        .gantt-container::-webkit-scrollbar-thumb:active {
            background: linear-gradient(180deg, #495057 0%, #343a40 100%);
        }
        
        .gantt-container::-webkit-scrollbar-corner {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
        }
        
        /* Scrollbar arrows */
        .gantt-container::-webkit-scrollbar-button {
            width: 16px;
            height: 16px;
            background: #e9ecef;
            border: 1px solid #dee2e6;
        }
        
        .gantt-container::-webkit-scrollbar-button:hover {
            background: #dee2e6;
        }
        
        .axis {
            font-size: 12px;
        }
        
        .axis-label {
            font-size: 14px;
            font-weight: bold;
            fill: #495057;
        }
        
        .project-row {
            cursor: pointer;
        }
        
        .project-label {
            font-size: 13px;
            font-weight: 500;
            fill: #343a40;
        }
        
        .preparing-bar {
            fill: #6c757d;
            stroke: #495057;
            stroke-width: 1;
        }
        
        .execution-bar {
            stroke: #343a40;
            stroke-width: 1;
        }
        
        .progress-bar {
            opacity: 0.8;
        }
        
        .priority-critical { fill: #dc3545; }
        .priority-high { fill: #fd7e14; }
        .priority-medium { fill: #ffc107; }
        .priority-low { fill: #28a745; }
        
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px;
            border-radius: 6px;
            font-size: 13px;
            line-height: 1.4;
            max-width: 300px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            pointer-events: none;
        }
        
        .tooltip-title {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 8px;
            color: #fff;
        }
        
        .tooltip-item {
            margin: 4px 0;
        }
        
        .legend {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #495057;
        }
        
        .legend-color {
            width: 20px;
            height: 15px;
            border-radius: 3px;
            border: 1px solid #ccc;
        }

        .info-bar {
            padding: 10px 20px;
            background: #e9ecef;
            border-bottom: 1px solid #dee2e6;
            text-align: center;
            flex-shrink: 0;
            font-size: 14px;
            color: #495057;
        }

        /* Filter Controls */
        .filter-section {
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            padding: 16px 20px;
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
            flex-shrink: 0;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-label {
            font-size: 14px;
            font-weight: 500;
            color: #495057;
            min-width: fit-content;
        }

        .filter-select, .filter-input {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            color: #495057;
            min-width: 140px;
            transition: border-color 0.15s ease;
        }

        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        .clear-filters-btn {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.15s ease;
        }

        .clear-filters-btn:hover {
            background: #0056b3;
        }

        .scroll-hint {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }
        
        .gantt-today-line {
            background: #2684ff !important;
            width: 2px !important;
            z-index: 15 !important;
            position: fixed !important;
            color: #1e40af;
            font-size: 12px;
            font-weight: 700;
            display: flex;
            align-items: flex-start;
            justify-content: flex-start;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
        }
        
        .gantt-today-line::before {
            content: attr(data-today-text);
            position: absolute;
            top: 0;
            left: 5px;
            background: rgba(255, 255, 255, 0.9);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            color: #2684ff;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Task Detail Modal */
        .task-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .task-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .task-modal-content {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            max-height: 80%;
            overflow-y: auto;
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }

        .task-modal-header {
            margin-bottom: 24px;
        }

        .task-modal-title {
            font-size: 24px;
            font-weight: 600;
            color: #343a40;
            margin-bottom: 8px;
        }

        .task-modal-subtitle {
            font-size: 16px;
            color: #6c757d;
        }

        .task-modal-section {
            margin-bottom: 20px;
        }

        .task-modal-section h4 {
            font-size: 14px;
            font-weight: 600;
            color: #343a40;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .task-modal-section p {
            font-size: 15px;
            color: #495057;
            line-height: 1.5;
        }

        .task-modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6c757d;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background-color 0.15s ease;
        }

        .task-modal-close:hover {
            background: #f8f9fa;
        }

        /* Filter badges */
        .filter-badge {
            display: inline-flex;
            align-items: center;
            background: #007bff;
            color: white;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            margin-left: 8px;
        }

        .filter-badge .remove {
            margin-left: 6px;
            cursor: pointer;
            font-weight: bold;
        }

        /* Selected task styling */
        .progress-bar.selected {
            stroke: #007bff;
            stroke-width: 3;
            filter: drop-shadow(0 4px 8px rgba(0, 123, 255, 0.3));
        }

        .preparing-bar.selected {
            stroke: #007bff;
            stroke-width: 3;
            filter: drop-shadow(0 4px 8px rgba(0, 123, 255, 0.3));
        }
        
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>CQSS Project Gantt Chart</h1>
            <p>Cyber Query Security System - Project Timeline Overview</p>
        </div>
        
        <div class="info-bar">
            <span id="project-count">Loading projects...</span>
            <div class="scroll-hint">💡 Use scrollbars or Shift + mouse wheel for horizontal scroll, arrow keys for navigation</div>
        </div>
        
        <!-- Filter Controls -->
        <div class="filter-section">
            <div class="filter-group">
                <label class="filter-label">Priority:</label>
                <select id="priority-filter" class="filter-select">
                    <option value="" selected>All Priorities</option>
                    <option value="Critical">Critical</option>
                    <option value="High">High</option>
                    <option value="Medium">Medium</option>
                    <option value="Low">Low</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">Category:</label>
                <select id="category-filter" class="filter-select">
                    <option value="" selected>All Categories</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">Team Lead:</label>
                <select id="team-filter" class="filter-select">
                    <option value="" selected>All Teams</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">Progress:</label>
                <select id="progress-filter" class="filter-select">
                    <option value="" selected>All Progress</option>
                    <option value="0-25">0-25%</option>
                    <option value="26-50">26-50%</option>
                    <option value="51-75">51-75%</option>
                    <option value="76-100">76-100%</option>
                </select>
            </div>
            
            <button id="clear-filters" class="clear-filters-btn">Clear All</button>
            
            <div id="active-filters"></div>
        </div>
        
        <div class="gantt-container" id="gantt-container">
            <svg class="gantt-chart"></svg>
        </div>
        
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background-color: #6c757d;"></div>
                <span>Preparing</span>
            </div>
            <div class="legend-item">
                <div class="legend-color priority-critical"></div>
                <span>Critical Priority</span>
            </div>
            <div class="legend-item">
                <div class="legend-color priority-high"></div>
                <span>High Priority</span>
            </div>
            <div class="legend-item">
                <div class="legend-color priority-medium"></div>
                <span>Medium Priority</span>
            </div>
            <div class="legend-item">
                <div class="legend-color priority-low"></div>
                <span>Low Priority</span>
            </div>
        </div>
    </div>
    
    <div class="tooltip" id="tooltip" style="display: none;"></div>
    
    <!-- Task Detail Modal -->
    <div class="task-modal" id="task-modal">
        <div class="task-modal-content">
            <button class="task-modal-close" id="modal-close">&times;</button>
            <div class="task-modal-header">
                <div class="task-modal-title" id="modal-title"></div>
                <div class="task-modal-subtitle" id="modal-subtitle"></div>
            </div>
            <div class="task-modal-section">
                <h4>Details</h4>
                <div id="modal-details"></div>
            </div>
            <div class="task-modal-section">
                <h4>Timeline</h4>
                <div id="modal-timeline"></div>
            </div>
            <div class="task-modal-section">
                <h4>Description</h4>
                <div id="modal-description"></div>
            </div>
        </div>
    </div>
    
    <script>
        // Global variables for filter functionality
        let allProjectData;
        let filteredProjectData;
        let currentFilters = {};
        let selectedTaskElement = null;

        function initChart() {
            // Project data will be embedded here
            const projectData = [
  {
    "id": "project_0",
    "name": "Project Alpha",
    "category": "Security",
    "priority": "High",
    "description": "Implement new authentication system",
    "team_lead": "John Smith",
    "stages": [
      {
        "name": "Preparing",
        "start": "2024-01-15T00:00:00",
        "end": "2024-02-15T00:00:00",
        "duration_days": 31,
        "progress_percent": 100
      },
      {
        "name": "Execution",
        "start": "2024-02-15T00:00:00",
        "end": "2024-05-15T00:00:00",
        "duration_days": 90,
        "progress_percent": 75
      }
    ],
    "preparing_stage": {
      "name": "Preparing",
      "start": "2024-01-15T00:00:00",
      "end": "2024-02-15T00:00:00",
      "duration_days": 31,
      "progress_percent": 100
    },
    "execution_stage": {
      "name": "Execution",
      "start": "2024-02-15T00:00:00",
      "end": "2024-05-15T00:00:00",
      "duration_days": 90,
      "progress_percent": 75
    },
    "total_duration_days": 121
  },
  {
    "id": "project_1",
    "name": "Project Beta",
    "category": "Infrastructure",
    "priority": "Medium",
    "description": "Database migration and optimization",
    "team_lead": "Jane Doe",
    "stages": [
      {
        "name": "Preparing",
        "start": "2024-02-01T00:00:00",
        "end": "2024-03-01T00:00:00",
        "duration_days": 29,
        "progress_percent": 100
      },
      {
        "name": "Execution",
        "start": "2024-03-01T00:00:00",
        "end": "2024-06-01T00:00:00",
        "duration_days": 92,
        "progress_percent": 45
      }
    ],
    "preparing_stage": {
      "name": "Preparing",
      "start": "2024-02-01T00:00:00",
      "end": "2024-03-01T00:00:00",
      "duration_days": 29,
      "progress_percent": 100
    },
    "execution_stage": {
      "name": "Execution",
      "start": "2024-03-01T00:00:00",
      "end": "2024-06-01T00:00:00",
      "duration_days": 92,
      "progress_percent": 45
    },
    "total_duration_days": 121
  },
  {
    "id": "project_2",
    "name": "Project Gamma",
    "category": "Development",
    "priority": "High",
    "description": "Frontend redesign and UX improvements",
    "team_lead": "Mike Johnson",
    "stages": [
      {
        "name": "Preparing",
        "start": "2024-01-01T00:00:00",
        "end": "2024-01-15T00:00:00",
        "duration_days": 14,
        "progress_percent": 100
      },
      {
        "name": "Execution",
        "start": "2024-01-15T00:00:00",
        "end": "2024-04-01T00:00:00",
        "duration_days": 77,
        "progress_percent": 90
      }
    ],
    "preparing_stage": {
      "name": "Preparing",
      "start": "2024-01-01T00:00:00",
      "end": "2024-01-15T00:00:00",
      "duration_days": 14,
      "progress_percent": 100
    },
    "execution_stage": {
      "name": "Execution",
      "start": "2024-01-15T00:00:00",
      "end": "2024-04-01T00:00:00",
      "duration_days": 77,
      "progress_percent": 90
    },
    "total_duration_days": 91
  },
  {
    "id": "project_3",
    "name": "Project Delta",
    "category": "Compliance",
    "priority": "Critical",
    "description": "GDPR compliance implementation",
    "team_lead": "Sarah Wilson",
    "stages": [
      {
        "name": "Preparing",
        "start": "2024-03-01T00:00:00",
        "end": "2024-03-15T00:00:00",
        "duration_days": 14,
        "progress_percent": 100
      },
      {
        "name": "Execution",
        "start": "2024-03-15T00:00:00",
        "end": "2024-07-01T00:00:00",
        "duration_days": 108,
        "progress_percent": 30
      }
    ],
    "preparing_stage": {
      "name": "Preparing",
      "start": "2024-03-01T00:00:00",
      "end": "2024-03-15T00:00:00",
      "duration_days": 14,
      "progress_percent": 100
    },
    "execution_stage": {
      "name": "Execution",
      "start": "2024-03-15T00:00:00",
      "end": "2024-07-01T00:00:00",
      "duration_days": 108,
      "progress_percent": 30
    },
    "total_duration_days": 122
  },
  {
    "id": "project_4",
    "name": "Project Epsilon",
    "category": "Research",
    "priority": "Low",
    "description": "AI integration feasibility study",
    "team_lead": "David Brown",
    "stages": [
      {
        "name": "Preparing",
        "start": "2024-02-15T00:00:00",
        "end": "2024-04-15T00:00:00",
        "duration_days": 60,
        "progress_percent": 100
      },
      {
        "name": "Execution",
        "start": "2024-04-15T00:00:00",
        "end": "2024-08-15T00:00:00",
        "duration_days": 122,
        "progress_percent": 10
      }
    ],
    "preparing_stage": {
      "name": "Preparing",
      "start": "2024-02-15T00:00:00",
      "end": "2024-04-15T00:00:00",
      "duration_days": 60,
      "progress_percent": 100
    },
    "execution_stage": {
      "name": "Execution",
      "start": "2024-04-15T00:00:00",
      "end": "2024-08-15T00:00:00",
      "duration_days": 122,
      "progress_percent": 10
    },
    "total_duration_days": 182
  }
];
            const dateRange = {
  "min_date": "2024-01-01T00:00:00",
  "max_date": "2024-08-15T00:00:00"
};
            
            // Initialize filter variables
            allProjectData = [...projectData];
            filteredProjectData = [...projectData];
            
            // Initialize filter options after data is available
            populateFilterOptions();
            
            document.getElementById('project-count').textContent = `${projectData.length} projects loaded`;
        
        // Chart configuration optimized for both horizontal and vertical scrolling
        const margin = { top: 50, right: 50, bottom: 100, left: 320 };
        const width = 3000 - margin.left - margin.right; // Wider for more horizontal scroll range
        const height = projectData.length * 65 - margin.top - margin.bottom; // Responsive height
        const barHeight = 30;
        const rowHeight = 65;
        
        // Create SVG
        const svg = d3.select('.gantt-chart')
            .attr('width', width + margin.left + margin.right)
            .attr('height', height + margin.top + margin.bottom);
        
        const g = svg.append('g')
            .attr('transform', `translate(${margin.left},${margin.top})`);
        
        // Parse dates
        const parseTime = d3.timeParse('%Y-%m-%dT%H:%M:%S');
        const minDate = parseTime(dateRange.min_date);
        const maxDate = parseTime(dateRange.max_date);
        
        // Calculate 2-week range starting from Sunday
        function getStartOfWeek(date) {
            const d = new Date(date);
            const day = d.getDay(); // 0 = Sunday, 1 = Monday, etc.
            const diff = d.getDate() - day;
            return new Date(d.setDate(diff));
        }
        
        function getEndOfWeek(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() + (6 - day);
            return new Date(d.setDate(diff));
        }
        
        // Extended timeline for better horizontal scrolling (4 weeks)
        const startOfFirstWeek = getStartOfWeek(minDate);
        const endOfExtendedPeriod = new Date(startOfFirstWeek);
        endOfExtendedPeriod.setDate(startOfFirstWeek.getDate() + 27); // 28 days total (4 weeks)
        
        const paddedMinDate = startOfFirstWeek;
        const paddedMaxDate = endOfExtendedPeriod;
        
        // Scales
        const xScale = d3.scaleTime()
            .domain([paddedMinDate, paddedMaxDate])
            .range([0, width]);
        
        const yScale = d3.scaleBand()
            .domain(projectData.map(d => d.name))
            .range([0, height])
            .padding(0.1);
        
        // Priority color scale
        const priorityColors = {
            'Critical': '#dc3545',
            'High': '#fd7e14',
            'Medium': '#ffc107',
            'Low': '#28a745'
        };
        
        // Create tooltip
        const tooltip = d3.select('#tooltip');
        
        // Add axes with daily ticks
        const xAxis = d3.axisBottom(xScale)
            .tickFormat(d => {
                const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                return dayNames[d.getDay()] + '\n' + d3.timeFormat('%m/%d')(d);
            })
            .ticks(d3.timeDay.every(1));
        
        g.append('g')
            .attr('class', 'axis')
            .attr('transform', `translate(0,${height})`)
            .call(xAxis)
            .selectAll('text')
            .style('text-anchor', 'middle')
            .style('font-size', '10px')
            .attr('dy', '1em');
        
        // Add week separators
        const weekTicks = d3.timeWeek.range(paddedMinDate, paddedMaxDate, 1);
        g.selectAll('.week-separator')
            .data(weekTicks)
            .enter()
            .append('line')
            .attr('class', 'week-separator')
            .attr('x1', d => xScale(d))
            .attr('x2', d => xScale(d))
            .attr('y1', 0)
            .attr('y2', height)
            .style('stroke', '#007bff')
            .style('stroke-width', 2)
            .style('opacity', 0.7);
        
        const yAxis = d3.axisLeft(yScale);
        
        g.append('g')
            .attr('class', 'axis')
            .call(yAxis);
        
        // Add daily grid lines
        g.append('g')
            .attr('class', 'grid')
            .attr('transform', `translate(0,${height})`)
            .call(d3.axisBottom(xScale)
                .tickSize(-height)
                .tickFormat('')
                .ticks(d3.timeDay.every(1))
            )
            .style('stroke-dasharray', '2,2')
            .style('opacity', 0.2);
        
        // Add weekend highlighting
        const weekendDays = d3.timeDay.range(paddedMinDate, paddedMaxDate, 1)
            .filter(d => d.getDay() === 0 || d.getDay() === 6); // Sunday = 0, Saturday = 6
        
        g.selectAll('.weekend-highlight')
            .data(weekendDays)
            .enter()
            .append('rect')
            .attr('class', 'weekend-highlight')
            .attr('x', d => xScale(d))
            .attr('y', 0)
            .attr('width', xScale(new Date(paddedMinDate.getTime() + 24*60*60*1000)) - xScale(paddedMinDate))
            .attr('height', height)
            .style('fill', '#f8f9fa')
            .style('opacity', 0.5);
        
        // Add enhanced today's line with horizontal text
        const today = new Date();
        const todayX = xScale(today);
        
        if (todayX >= 0 && todayX <= width) {
            // Create enhanced today line div
            const todayLine = document.createElement('div');
            todayLine.className = 'gantt-vertical-line gantt-today-line';
            
            // Add today text as data attribute for CSS ::before pseudo-element
            const formatToday = d3.timeFormat('%Y/%m/%d');
            todayLine.setAttribute('data-today-text', `Today ${formatToday(today)}`);
            
            // Calculate fixed position relative to the content wrapper
            const contentWrapper = document.querySelector('.gantt-timeline-content-wrapper');
            const contentRect = contentWrapper.getBoundingClientRect();
            const fixedX = contentRect.left + Math.min(todayX - contentWrapper.scrollLeft, contentWrapper.clientWidth);
            
            todayLine.style.left = fixedX + 'px';
            todayLine.style.top = contentRect.top + 'px';
            todayLine.style.height = contentRect.height + 'px';
            todayLine.style.display = 'block';
            
            document.body.appendChild(todayLine);
            
            // Update position on scroll
            contentWrapper.addEventListener('scroll', function() {
                const newContentRect = contentWrapper.getBoundingClientRect();
                const newFixedX = newContentRect.left + Math.min(todayX - contentWrapper.scrollLeft, contentWrapper.clientWidth);
                todayLine.style.left = newFixedX + 'px';
                todayLine.style.top = newContentRect.top + 'px';
                todayLine.style.height = newContentRect.height + 'px';
                
                // Hide/show based on visibility
                if (todayX - contentWrapper.scrollLeft < 0 || todayX - contentWrapper.scrollLeft > contentWrapper.clientWidth) {
                    todayLine.style.display = 'none';
                } else {
                    todayLine.style.display = 'block';
                }
            });
        }
        
        // Create project groups
        const projectGroups = g.selectAll('.project-group')
            .data(filteredProjectData)
            .enter()
            .append('g')
            .attr('class', 'project-group')
            .attr('transform', d => `translate(0,${yScale(d.name)})`);
        
        // Define stage colors for multi-stage support
        const stageColors = {
            'Planning': '#6f42c1',
            'Preparing': '#6f42c1', 
            'Analysis': '#17a2b8',
            'Research': '#17a2b8',
            'Design': '#20c997',
            'Wireframes': '#20c997',
            'Development': '#28a745',
            'Implementation': '#28a745',
            'Testing': '#ffc107',
            'Audit': '#ffc107',
            'Migration': '#fd7e14',
            'Deployment': '#dc3545',
            'Execution': '#007bff'
        };
        
        // Add stage bars dynamically
        projectGroups.each(function(d) {
            const group = d3.select(this);
            
            d.stages.forEach((stage, index) => {
                const isLastStage = index === d.stages.length - 1;
                const stageColor = stageColors[stage.name] || (index === 0 ? '#6f42c1' : priorityColors[d.priority] || '#6c757d');
                
                // Add stage background bar
                group.append('rect')
                    .attr('class', `stage-bar stage-${index}`)
                    .attr('x', xScale(parseTime(stage.start)))
                    .attr('y', (yScale.bandwidth() - barHeight) / 2)
                    .attr('width', xScale(parseTime(stage.end)) - xScale(parseTime(stage.start)))
                    .attr('height', barHeight)
                    .attr('fill', stageColor)
                    .attr('opacity', stage.progress_percent === 100 ? 0.8 : 0.3);
                
                // Add progress bar for stages with partial progress
                if (stage.progress_percent < 100 && stage.progress_percent > 0) {
                    group.append('rect')
                        .attr('class', `progress-bar stage-${index}`)
                        .attr('x', xScale(parseTime(stage.start)))
                        .attr('y', (yScale.bandwidth() - barHeight) / 2)
                        .attr('width', (xScale(parseTime(stage.end)) - xScale(parseTime(stage.start))) * (stage.progress_percent / 100))
                        .attr('height', barHeight)
                        .attr('fill', stageColor);
                }
            });
        });
        
        // Add interactive overlays for each project
        projectGroups.append('rect')
            .attr('class', 'interaction-overlay')
            .attr('x', d => xScale(parseTime(d.stages[0].start)))
            .attr('y', (yScale.bandwidth() - barHeight) / 2)
            .attr('width', d => xScale(parseTime(d.stages[d.stages.length - 1].end)) - xScale(parseTime(d.stages[0].start)))
            .attr('height', barHeight)
            .attr('fill', 'transparent')
            .style('cursor', 'pointer')
            .on('mouseover', function(event, d) {
                // Generate stage information dynamically
                const stagesHtml = d.stages.map(stage => 
                    `<div class="tooltip-item"><strong>${stage.name}:</strong> ${stage.start.split('T')[0]} to ${stage.end.split('T')[0]} (${stage.progress_percent}%)</div>`
                ).join('');
                
                tooltip.style('display', 'block')
                    .html(`
                        <div class="tooltip-title">${d.name}</div>
                        <div class="tooltip-item"><strong>Category:</strong> ${d.category}</div>
                        <div class="tooltip-item"><strong>Priority:</strong> ${d.priority}</div>
                        <div class="tooltip-item"><strong>Team Lead:</strong> ${d.team_lead}</div>
                        <div class="tooltip-item"><strong>Overall Progress:</strong> ${d.execution_stage.progress_percent}%</div>
                        <div class="tooltip-item"><strong>Description:</strong> ${d.description}</div>
                        <div class="tooltip-section"><strong>Stages:</strong></div>
                        ${stagesHtml}
                    `);
            })
            .on('mousemove', function(event) {
                tooltip.style('left', (event.pageX + 10) + 'px')
                    .style('top', (event.pageY - 10) + 'px');
            })
            .on('mouseout', function() {
                tooltip.style('display', 'none');
            })
            .on('click', function(event, d) {
                // Remove previous selection
                if (selectedTaskElement) {
                    selectedTaskElement.classed('selected', false);
                }
                
                // Add selection to clicked element
                d3.select(this).classed('selected', true);
                selectedTaskElement = d3.select(this);
                
                // Open modal
                openModal(d);
            });
            
        // Add click handlers to preparing bars too
        projectGroups.selectAll('.preparing-bar')
            .on('click', function(event, d) {
                // Remove previous selection
                if (selectedTaskElement) {
                    selectedTaskElement.classed('selected', false);
                }
                
                // Add selection to clicked element
                d3.select(this).classed('selected', true);
                selectedTaskElement = d3.select(this);
                
                // Open modal
                openModal(d);
            });
        
        // Add project names centered across all stages
        projectGroups.append('text')
            .attr('x', d => {
                const startX = xScale(parseTime(d.stages[0].start));
                const endX = xScale(parseTime(d.stages[d.stages.length - 1].end));
                return startX + (endX - startX) / 2;
            })
            .attr('y', (yScale.bandwidth() - barHeight) / 2 + barHeight / 2 - 4)
            .attr('dy', '0.35em')
            .attr('text-anchor', 'middle')
            .style('font-size', '13px')
            .style('font-weight', 'bold')
            .style('fill', 'white')
            .style('text-shadow', '1px 1px 3px rgba(0,0,0,0.9)')
            .text(d => {
                const totalBarWidth = xScale(parseTime(d.stages[d.stages.length - 1].end)) - xScale(parseTime(d.stages[0].start));
                const maxChars = Math.floor(totalBarWidth / 8); // Estimate characters that fit
                return d.name.length > maxChars && maxChars > 3 ? 
                    d.name.substring(0, maxChars - 3) + '...' : d.name;
            });

        // Add stage progress labels for each stage (enhanced display)
        projectGroups.each(function(d) {
            const group = d3.select(this);
            
            d.stages.forEach((stage, index) => {
                const stageWidth = xScale(parseTime(stage.end)) - xScale(parseTime(stage.start));
                const stageStartX = xScale(parseTime(stage.start));
                const progressPercent = stage.progress_percent;
                
                // Consistent semi-transparent background for all progress indicators
                const progressBgColor = 'rgba(0, 0, 0, 0.2)'; // Lighter semi-transparent black background
                
                // Always show progress percentage if there's enough space
                if (stageWidth > 30) {
                    // Position text in center of stage bar
                    const textX = stageStartX + stageWidth / 2;
                    
                    group.append('text')
                        .attr('x', textX)
                        .attr('y', (yScale.bandwidth() - barHeight) / 2 + barHeight / 2)
                        .attr('dy', '0.35em')
                        .attr('text-anchor', 'middle')
                        .style('font-size', '11px')
                        .style('font-weight', 'bold')
                        .style('fill', '#ffffff')
                        .style('text-shadow', '0 0 3px rgba(0,0,0,1)')
                        .style('paint-order', 'stroke fill')
                        .style('stroke', progressBgColor)
                        .style('stroke-width', '3px')
                        .style('pointer-events', 'none')
                        .text(`${progressPercent}%`);
                    
                    // Add stage name below progress for longer stages
                    if (stageWidth > 80) {
                        group.append('text')
                            .attr('x', textX)
                            .attr('y', (yScale.bandwidth() - barHeight) / 2 + barHeight / 2 + 14)
                            .attr('dy', '0.35em')
                            .attr('text-anchor', 'middle')
                            .style('font-size', '9px')
                            .style('font-weight', '500')
                            .style('fill', '#666')
                            .style('pointer-events', 'none')
                            .text(stage.name.length > 12 ? stage.name.substring(0, 10) + '...' : stage.name);
                    }
                }
            });
        });
        
        // Add chart title
        svg.append('text')
            .attr('x', (width + margin.left + margin.right) / 2)
            .attr('y', 30)
            .attr('text-anchor', 'middle')
            .style('font-size', '16px')
            .style('font-weight', 'bold')
            .style('fill', '#343a40')
            .text('Project Timeline and Progress Overview');

        // Enhanced scroll behavior
        const container = document.getElementById('gantt-container');
        if (container) {
            // Enable smooth horizontal scrolling with Shift + mouse wheel
            container.addEventListener('wheel', function(e) {
                if (e.shiftKey) {
                    e.preventDefault();
                    container.scrollLeft += e.deltaY;
                }
            });
            
            // Add keyboard navigation
            container.addEventListener('keydown', function(e) {
                const scrollAmount = 50;
                switch(e.key) {
                    case 'ArrowLeft':
                        e.preventDefault();
                        container.scrollLeft -= scrollAmount;
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        container.scrollLeft += scrollAmount;
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        container.scrollTop -= scrollAmount;
                        break;
                    case 'ArrowDown':
                        e.preventDefault();
                        container.scrollTop += scrollAmount;
                        break;
                }
            });
            
            // Make container focusable for keyboard navigation
            container.setAttribute('tabindex', '0');
        }
        }
        
        // Add click handler to deselect when clicking elsewhere
        document.addEventListener('click', function(event) {
            if (!event.target.closest('rect') && !event.target.closest('.task-modal-content')) {
                if (selectedTaskElement) {
                    selectedTaskElement.classed('selected', false);
                    selectedTaskElement = null;
                }
            }
        });
        
        function setupFilters() {
            // Priority filter
            document.getElementById('priority-filter').addEventListener('change', (e) => {
                if (e.target.value) {
                    currentFilters.priority = e.target.value;
                } else {
                    delete currentFilters.priority;
                }
                applyFilters();
            });

            // Category filter
            document.getElementById('category-filter').addEventListener('change', (e) => {
                if (e.target.value) {
                    currentFilters.category = e.target.value;
                } else {
                    delete currentFilters.category;
                }
                applyFilters();
            });

            // Team filter
            document.getElementById('team-filter').addEventListener('change', (e) => {
                if (e.target.value) {
                    currentFilters.team = e.target.value;
                } else {
                    delete currentFilters.team;
                }
                applyFilters();
            });

            // Progress filter
            document.getElementById('progress-filter').addEventListener('change', (e) => {
                if (e.target.value) {
                    currentFilters.progress = e.target.value;
                } else {
                    delete currentFilters.progress;
                }
                applyFilters();
            });

            // Clear all filters
            document.getElementById('clear-filters').addEventListener('click', () => {
                currentFilters = {};
                document.querySelectorAll('.filter-select').forEach(select => {
                    select.value = '';
                });
                applyFilters();
            });
        }
        
        function populateFilterOptions() {
            // Get unique categories and team leads
            const categories = [...new Set(allProjectData.map(p => p.category))];
            const teamLeads = [...new Set(allProjectData.map(p => p.team_lead))];
            
            // Populate category filter
            const categorySelect = document.getElementById('category-filter');
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            });
            
            // Populate team filter
            const teamSelect = document.getElementById('team-filter');
            teamLeads.forEach(teamLead => {
                const option = document.createElement('option');
                option.value = teamLead;
                option.textContent = teamLead;
                teamSelect.appendChild(option);
            });
        }
        
        function applyFilters() {
            filteredProjectData = allProjectData.filter(project => {
                // Priority filter
                if (currentFilters.priority && project.priority !== currentFilters.priority) {
                    return false;
                }

                // Category filter
                if (currentFilters.category && project.category !== currentFilters.category) {
                    return false;
                }

                // Team lead filter
                if (currentFilters.team && project.team_lead !== currentFilters.team) {
                    return false;
                }

                // Progress filter
                if (currentFilters.progress) {
                    const progress = project.execution_stage.progress_percent;
                    const [min, max] = currentFilters.progress.split('-').map(Number);
                    if (progress < min || progress > max) {
                        return false;
                    }
                }

                return true;
            });

            updateProjectInfo();
            updateActiveFilters();
            
            // Re-render chart with filtered data
            d3.select('.gantt-chart').selectAll('*').remove();
            initChart();
        }
        
        function updateProjectInfo() {
            document.getElementById('project-count').textContent = `${filteredProjectData.length} of ${allProjectData.length} projects loaded`;
        }
        
        function updateActiveFilters() {
            const activeFiltersDiv = document.getElementById('active-filters');
            activeFiltersDiv.innerHTML = '';
            
            Object.keys(currentFilters).forEach(filterKey => {
                const badge = document.createElement('span');
                badge.className = 'filter-badge';
                badge.innerHTML = `${filterKey}: ${currentFilters[filterKey]} <span class="remove" data-filter="${filterKey}">×</span>`;
                activeFiltersDiv.appendChild(badge);
            });
            
            // Add click handlers for remove buttons
            activeFiltersDiv.querySelectorAll('.remove').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const filterKey = e.target.dataset.filter;
                    delete currentFilters[filterKey];
                    document.getElementById(`${filterKey}-filter`).value = '';
                    applyFilters();
                });
            });
        }
        
        function setupModal() {
            const modal = document.getElementById('task-modal');
            const closeBtn = document.getElementById('modal-close');

            closeBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal();
                }
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeModal();
                }
            });
        }

        function openModal(project) {
            const modal = document.getElementById('task-modal');
            const title = document.getElementById('modal-title');
            const subtitle = document.getElementById('modal-subtitle');
            const details = document.getElementById('modal-details');
            const timeline = document.getElementById('modal-timeline');
            const description = document.getElementById('modal-description');

            title.textContent = project.name;
            subtitle.textContent = `${project.category} • Led by ${project.team_lead}`;

            details.innerHTML = `
                <p><strong>Priority:</strong> ${project.priority}</p>
                <p><strong>Progress:</strong> ${project.execution_stage.progress_percent}%</p>
                <p><strong>Status:</strong> ${getProjectStatus(project)}</p>
            `;

            const prepStart = new Date(project.preparing_stage.start);
            const prepEnd = new Date(project.preparing_stage.end);
            const execStart = new Date(project.execution_stage.start);
            const execEnd = new Date(project.execution_stage.end);

            timeline.innerHTML = `
                <p><strong>Preparation:</strong> ${prepStart.toLocaleDateString()} - ${prepEnd.toLocaleDateString()}</p>
                <p><strong>Execution:</strong> ${execStart.toLocaleDateString()} - ${execEnd.toLocaleDateString()}</p>
                <p><strong>Total Duration:</strong> ${Math.ceil((execEnd - prepStart) / (1000 * 60 * 60 * 24))} days</p>
            `;

            description.textContent = project.description;

            modal.classList.add('active');
        }

        function closeModal() {
            const modal = document.getElementById('task-modal');
            modal.classList.remove('active');
            
            // Remove selection from task
            if (selectedTaskElement) {
                selectedTaskElement.classed('selected', false);
                selectedTaskElement = null;
            }
        }

        function getProjectStatus(project) {
            const now = new Date();
            const execEnd = new Date(project.execution_stage.end);
            const progress = project.execution_stage.progress_percent;

            if (progress === 100) return 'Completed';
            if (now > execEnd) return 'Overdue';
            if (progress > 0) return 'In Progress';
            return 'Not Started';
        }

        // Load D3.js and initialize chart
        (function(){
            var script = document.createElement('script');
            script.src = 'https://d3js.org/d3.v7.min.js';
            script.onload = function() {
                initChart();
                setupFilters();
                populateFilterOptions();
                setupModal();
            };
            script.onerror = function() {
                alert('Cannot load D3.js from CDN. This chart requires an internet connection.');
            };
            document.head.appendChild(script);
        })();
    </script>
</body>
</html>