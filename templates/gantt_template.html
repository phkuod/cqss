<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CQSS Project Gantt Chart</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f8f9fa;
            height: 100vh;
            overflow: hidden;
        }
        
        .container {
            width: 100%;
            height: calc(100vh - 40px);
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }
        
        .header {
            text-align: center;
            padding: 15px 20px;
            border-bottom: 2px solid #e9ecef;
            flex-shrink: 0;
            background: white;
            border-radius: 8px 8px 0 0;
        }
        
        .header h1 {
            color: #343a40;
            margin: 0;
            font-size: 2.2em;
        }
        
        .header p {
            color: #6c757d;
            margin: 8px 0 0 0;
            font-size: 1.0em;
        }
        
        .gantt-container {
            flex: 1;
            overflow: auto;
            border: none;
            position: relative;
        }
        
        .gantt-chart {
            width: 100%;
            height: 100%;
        }
        
        /* Enhanced scrollbar styling */
        .gantt-container {
            scrollbar-width: thin;
            scrollbar-color: #6c757d #f8f9fa;
        }
        
        .gantt-container::-webkit-scrollbar {
            width: 16px;
            height: 16px;
        }
        
        .gantt-container::-webkit-scrollbar-track {
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .gantt-container::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #6c757d 0%, #5a6268 100%);
            border-radius: 8px;
            border: 2px solid #f8f9fa;
            min-height: 20px;
        }
        
        .gantt-container::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #5a6268 0%, #495057 100%);
        }
        
        .gantt-container::-webkit-scrollbar-thumb:active {
            background: linear-gradient(180deg, #495057 0%, #343a40 100%);
        }
        
        .gantt-container::-webkit-scrollbar-corner {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
        }
        
        /* Scrollbar arrows */
        .gantt-container::-webkit-scrollbar-button {
            width: 16px;
            height: 16px;
            background: #e9ecef;
            border: 1px solid #dee2e6;
        }
        
        .gantt-container::-webkit-scrollbar-button:hover {
            background: #dee2e6;
        }
        
        .axis {
            font-size: 12px;
        }
        
        .axis-label {
            font-size: 14px;
            font-weight: bold;
            fill: #495057;
        }
        
        .project-row {
            cursor: pointer;
        }
        
        .project-label {
            font-size: 13px;
            font-weight: 500;
            fill: #343a40;
        }
        
        .preparing-bar {
            fill: #6c757d;
            stroke: #495057;
            stroke-width: 1;
        }
        
        .execution-bar {
            stroke: #343a40;
            stroke-width: 1;
        }
        
        .progress-bar {
            opacity: 0.8;
        }
        
        .priority-critical { fill: #dc3545; }
        .priority-high { fill: #fd7e14; }
        .priority-medium { fill: #ffc107; }
        .priority-low { fill: #28a745; }
        
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px;
            border-radius: 6px;
            font-size: 13px;
            line-height: 1.4;
            max-width: 300px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            pointer-events: none;
        }
        
        .tooltip-title {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 8px;
            color: #fff;
        }
        
        .tooltip-item {
            margin: 4px 0;
        }
        
        .legend {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #495057;
        }
        
        .legend-color {
            width: 20px;
            height: 15px;
            border-radius: 3px;
            border: 1px solid #ccc;
        }

        .info-bar {
            padding: 10px 20px;
            background: #e9ecef;
            border-bottom: 1px solid #dee2e6;
            text-align: center;
            flex-shrink: 0;
            font-size: 14px;
            color: #495057;
        }

        .scroll-hint {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }
        
        .gantt-today-line {
            background: #2684ff !important;
            width: 2px !important;
            z-index: 15 !important;
            position: fixed !important;
            color: #1e40af;
            font-size: 12px;
            font-weight: 700;
            display: flex;
            align-items: flex-start;
            justify-content: flex-start;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
        }
        
        .gantt-today-line::before {
            content: attr(data-today-text);
            position: absolute;
            top: 0;
            left: 5px;
            background: rgba(255, 255, 255, 0.9);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            color: #2684ff;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>CQSS Project Gantt Chart</h1>
            <p>Cyber Query Security System - Project Timeline Overview</p>
        </div>
        
        <div class="info-bar">
            <span id="project-count">Loading projects...</span>
            <div class="scroll-hint">ðŸ’¡ Use scrollbars or Shift + mouse wheel for horizontal scroll, arrow keys for navigation</div>
        </div>
        
        <div class="gantt-container" id="gantt-container">
            <svg class="gantt-chart"></svg>
        </div>
        
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background-color: #6c757d;"></div>
                <span>Preparing</span>
            </div>
            <div class="legend-item">
                <div class="legend-color priority-critical"></div>
                <span>Critical Priority</span>
            </div>
            <div class="legend-item">
                <div class="legend-color priority-high"></div>
                <span>High Priority</span>
            </div>
            <div class="legend-item">
                <div class="legend-color priority-medium"></div>
                <span>Medium Priority</span>
            </div>
            <div class="legend-item">
                <div class="legend-color priority-low"></div>
                <span>Low Priority</span>
            </div>
        </div>
    </div>
    
    <div class="tooltip" id="tooltip" style="display: none;"></div>
    
    <script>
        function initChart() {
            // Project data will be embedded here
            const projectData = {{ project_data }};
            const dateRange = {{ date_range }};
            
            document.getElementById('project-count').textContent = `${projectData.length} projects loaded`;
        
        // Chart configuration optimized for both horizontal and vertical scrolling
        const margin = { top: 50, right: 50, bottom: 100, left: 320 };
        const width = 3000 - margin.left - margin.right; // Wider for more horizontal scroll range
        const height = projectData.length * 65 - margin.top - margin.bottom; // Responsive height
        const barHeight = 30;
        const rowHeight = 65;
        
        // Create SVG
        const svg = d3.select('.gantt-chart')
            .attr('width', width + margin.left + margin.right)
            .attr('height', height + margin.top + margin.bottom);
        
        const g = svg.append('g')
            .attr('transform', `translate(${margin.left},${margin.top})`);
        
        // Parse dates
        const parseTime = d3.timeParse('%Y-%m-%dT%H:%M:%S');
        const minDate = parseTime(dateRange.min_date);
        const maxDate = parseTime(dateRange.max_date);
        
        // Calculate 2-week range starting from Sunday
        function getStartOfWeek(date) {
            const d = new Date(date);
            const day = d.getDay(); // 0 = Sunday, 1 = Monday, etc.
            const diff = d.getDate() - day;
            return new Date(d.setDate(diff));
        }
        
        function getEndOfWeek(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() + (6 - day);
            return new Date(d.setDate(diff));
        }
        
        // Extended timeline for better horizontal scrolling (4 weeks)
        const startOfFirstWeek = getStartOfWeek(minDate);
        const endOfExtendedPeriod = new Date(startOfFirstWeek);
        endOfExtendedPeriod.setDate(startOfFirstWeek.getDate() + 27); // 28 days total (4 weeks)
        
        const paddedMinDate = startOfFirstWeek;
        const paddedMaxDate = endOfExtendedPeriod;
        
        // Scales
        const xScale = d3.scaleTime()
            .domain([paddedMinDate, paddedMaxDate])
            .range([0, width]);
        
        const yScale = d3.scaleBand()
            .domain(projectData.map(d => d.name))
            .range([0, height])
            .padding(0.1);
        
        // Priority color scale
        const priorityColors = {
            'Critical': '#dc3545',
            'High': '#fd7e14',
            'Medium': '#ffc107',
            'Low': '#28a745'
        };
        
        // Create tooltip
        const tooltip = d3.select('#tooltip');
        
        // Add axes with daily ticks
        const xAxis = d3.axisBottom(xScale)
            .tickFormat(d => {
                const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                return dayNames[d.getDay()] + '\n' + d3.timeFormat('%m/%d')(d);
            })
            .ticks(d3.timeDay.every(1));
        
        g.append('g')
            .attr('class', 'axis')
            .attr('transform', `translate(0,${height})`)
            .call(xAxis)
            .selectAll('text')
            .style('text-anchor', 'middle')
            .style('font-size', '10px')
            .attr('dy', '1em');
        
        // Add week separators
        const weekTicks = d3.timeWeek.range(paddedMinDate, paddedMaxDate, 1);
        g.selectAll('.week-separator')
            .data(weekTicks)
            .enter()
            .append('line')
            .attr('class', 'week-separator')
            .attr('x1', d => xScale(d))
            .attr('x2', d => xScale(d))
            .attr('y1', 0)
            .attr('y2', height)
            .style('stroke', '#007bff')
            .style('stroke-width', 2)
            .style('opacity', 0.7);
        
        const yAxis = d3.axisLeft(yScale);
        
        g.append('g')
            .attr('class', 'axis')
            .call(yAxis);
        
        // Add daily grid lines
        g.append('g')
            .attr('class', 'grid')
            .attr('transform', `translate(0,${height})`)
            .call(d3.axisBottom(xScale)
                .tickSize(-height)
                .tickFormat('')
                .ticks(d3.timeDay.every(1))
            )
            .style('stroke-dasharray', '2,2')
            .style('opacity', 0.2);
        
        // Add weekend highlighting
        const weekendDays = d3.timeDay.range(paddedMinDate, paddedMaxDate, 1)
            .filter(d => d.getDay() === 0 || d.getDay() === 6); // Sunday = 0, Saturday = 6
        
        g.selectAll('.weekend-highlight')
            .data(weekendDays)
            .enter()
            .append('rect')
            .attr('class', 'weekend-highlight')
            .attr('x', d => xScale(d))
            .attr('y', 0)
            .attr('width', xScale(new Date(paddedMinDate.getTime() + 24*60*60*1000)) - xScale(paddedMinDate))
            .attr('height', height)
            .style('fill', '#f8f9fa')
            .style('opacity', 0.5);
        
        // Add enhanced today's line with horizontal text
        const today = new Date();
        const todayX = xScale(today);
        
        if (todayX >= 0 && todayX <= width) {
            // Create enhanced today line div
            const todayLine = document.createElement('div');
            todayLine.className = 'gantt-vertical-line gantt-today-line';
            
            // Add today text as data attribute for CSS ::before pseudo-element
            const formatToday = d3.timeFormat('%Y/%m/%d');
            todayLine.setAttribute('data-today-text', `Today ${formatToday(today)}`);
            
            // Calculate fixed position relative to the content wrapper
            const contentWrapper = document.querySelector('.gantt-timeline-content-wrapper');
            const contentRect = contentWrapper.getBoundingClientRect();
            const fixedX = contentRect.left + Math.min(todayX - contentWrapper.scrollLeft, contentWrapper.clientWidth);
            
            todayLine.style.left = fixedX + 'px';
            todayLine.style.top = contentRect.top + 'px';
            todayLine.style.height = contentRect.height + 'px';
            todayLine.style.display = 'block';
            
            document.body.appendChild(todayLine);
            
            // Update position on scroll
            contentWrapper.addEventListener('scroll', function() {
                const newContentRect = contentWrapper.getBoundingClientRect();
                const newFixedX = newContentRect.left + Math.min(todayX - contentWrapper.scrollLeft, contentWrapper.clientWidth);
                todayLine.style.left = newFixedX + 'px';
                todayLine.style.top = newContentRect.top + 'px';
                todayLine.style.height = newContentRect.height + 'px';
                
                // Hide/show based on visibility
                if (todayX - contentWrapper.scrollLeft < 0 || todayX - contentWrapper.scrollLeft > contentWrapper.clientWidth) {
                    todayLine.style.display = 'none';
                } else {
                    todayLine.style.display = 'block';
                }
            });
        }
        
        // Create project groups
        const projectGroups = g.selectAll('.project-group')
            .data(projectData)
            .enter()
            .append('g')
            .attr('class', 'project-group')
            .attr('transform', d => `translate(0,${yScale(d.name)})`);
        
        // Add preparing stage bars
        projectGroups.append('rect')
            .attr('class', 'preparing-bar')
            .attr('x', d => xScale(parseTime(d.preparing_stage.start)))
            .attr('y', (yScale.bandwidth() - barHeight) / 2)
            .attr('width', d => xScale(parseTime(d.preparing_stage.end)) - xScale(parseTime(d.preparing_stage.start)))
            .attr('height', barHeight);
        
        // Add execution stage background bars
        projectGroups.append('rect')
            .attr('class', 'execution-bar')
            .attr('x', d => xScale(parseTime(d.execution_stage.start)))
            .attr('y', (yScale.bandwidth() - barHeight) / 2)
            .attr('width', d => xScale(parseTime(d.execution_stage.end)) - xScale(parseTime(d.execution_stage.start)))
            .attr('height', barHeight)
            .attr('fill', d => priorityColors[d.priority] || '#6c757d')
            .attr('opacity', 0.3);
        
        // Add execution stage progress bars
        projectGroups.append('rect')
            .attr('class', 'progress-bar execution-bar')
            .attr('x', d => xScale(parseTime(d.execution_stage.start)))
            .attr('y', (yScale.bandwidth() - barHeight) / 2)
            .attr('width', d => {
                const totalWidth = xScale(parseTime(d.execution_stage.end)) - xScale(parseTime(d.execution_stage.start));
                return totalWidth * (d.execution_stage.progress_percent / 100);
            })
            .attr('height', barHeight)
            .attr('fill', d => priorityColors[d.priority] || '#6c757d')
            .style('cursor', 'pointer')
            .on('mouseover', function(event, d) {
                tooltip.style('display', 'block')
                    .html(`
                        <div class="tooltip-title">${d.name}</div>
                        <div class="tooltip-item"><strong>Category:</strong> ${d.category}</div>
                        <div class="tooltip-item"><strong>Priority:</strong> ${d.priority}</div>
                        <div class="tooltip-item"><strong>Team Lead:</strong> ${d.team_lead}</div>
                        <div class="tooltip-item"><strong>Progress:</strong> ${d.execution_stage.progress_percent}%</div>
                        <div class="tooltip-item"><strong>Description:</strong> ${d.description}</div>
                        <div class="tooltip-item"><strong>Preparing:</strong> ${d.preparing_stage.start.split('T')[0]} to ${d.preparing_stage.end.split('T')[0]}</div>
                        <div class="tooltip-item"><strong>Execution:</strong> ${d.execution_stage.start.split('T')[0]} to ${d.execution_stage.end.split('T')[0]}</div>
                    `);
            })
            .on('mousemove', function(event) {
                tooltip.style('left', (event.pageX + 10) + 'px')
                    .style('top', (event.pageY - 10) + 'px');
            })
            .on('mouseout', function() {
                tooltip.style('display', 'none');
            })
            .on('click', function(event, d) {
                alert(`Project Details:\n\nName: ${d.name}\nCategory: ${d.category}\nPriority: ${d.priority}\nTeam Lead: ${d.team_lead}\nProgress: ${d.execution_stage.progress_percent}%\nDescription: ${d.description}`);
            });
        
        // Add project names to execution bars
        projectGroups.append('text')
            .attr('x', d => {
                const startX = xScale(parseTime(d.execution_stage.start));
                const endX = xScale(parseTime(d.execution_stage.end));
                return startX + (endX - startX) / 2;
            })
            .attr('y', (yScale.bandwidth() - barHeight) / 2 + barHeight / 2 - 4)
            .attr('dy', '0.35em')
            .attr('text-anchor', 'middle')
            .style('font-size', '13px')
            .style('font-weight', 'bold')
            .style('fill', 'white')
            .style('text-shadow', '1px 1px 3px rgba(0,0,0,0.9)')
            .text(d => {
                const barWidth = xScale(parseTime(d.execution_stage.end)) - xScale(parseTime(d.execution_stage.start));
                const maxChars = Math.floor(barWidth / 8); // Estimate characters that fit
                return d.name.length > maxChars && maxChars > 3 ? 
                    d.name.substring(0, maxChars - 3) + '...' : d.name;
            });

        // Add progress percentage labels at end of progress bar
        projectGroups.append('text')
            .attr('x', d => {
                const startX = xScale(parseTime(d.execution_stage.start));
                const totalWidth = xScale(parseTime(d.execution_stage.end)) - startX;
                const progressWidth = totalWidth * (d.execution_stage.progress_percent / 100);
                // Position at the end of the progress bar, with a small offset
                return startX + progressWidth + 5;
            })
            .attr('y', (yScale.bandwidth() - barHeight) / 2 + barHeight / 2)
            .attr('dy', '0.35em')
            .attr('text-anchor', 'start')
            .style('font-size', '11px')
            .style('font-weight', 'bold')
            .style('fill', '#343a40')
            .style('text-shadow', '1px 1px 2px rgba(255,255,255,0.8)')
            .text(d => {
                const barWidth = xScale(parseTime(d.execution_stage.end)) - xScale(parseTime(d.execution_stage.start));
                const progressWidth = barWidth * (d.execution_stage.progress_percent / 100);
                // Show percentage if there's enough space and progress > 0
                return progressWidth > 20 && d.execution_stage.progress_percent > 0 ? `${d.execution_stage.progress_percent}%` : '';
            });
        
        // Add chart title
        svg.append('text')
            .attr('x', (width + margin.left + margin.right) / 2)
            .attr('y', 30)
            .attr('text-anchor', 'middle')
            .style('font-size', '16px')
            .style('font-weight', 'bold')
            .style('fill', '#343a40')
            .text('Project Timeline and Progress Overview');

        // Enhanced scroll behavior
        const container = document.getElementById('gantt-container');
        if (container) {
            // Enable smooth horizontal scrolling with Shift + mouse wheel
            container.addEventListener('wheel', function(e) {
                if (e.shiftKey) {
                    e.preventDefault();
                    container.scrollLeft += e.deltaY;
                }
            });
            
            // Add keyboard navigation
            container.addEventListener('keydown', function(e) {
                const scrollAmount = 50;
                switch(e.key) {
                    case 'ArrowLeft':
                        e.preventDefault();
                        container.scrollLeft -= scrollAmount;
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        container.scrollLeft += scrollAmount;
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        container.scrollTop -= scrollAmount;
                        break;
                    case 'ArrowDown':
                        e.preventDefault();
                        container.scrollTop += scrollAmount;
                        break;
                }
            });
            
            // Make container focusable for keyboard navigation
            container.setAttribute('tabindex', '0');
        }
        }

        // Load D3.js and initialize chart
        (function(){
            var script = document.createElement('script');
            script.src = 'https://d3js.org/d3.v7.min.js';
            script.onload = initChart;
            script.onerror = function() {
                alert('Cannot load D3.js from CDN. This chart requires an internet connection.');
            };
            document.head.appendChild(script);
        })();
    </script>
</body>
</html>